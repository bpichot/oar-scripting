# Description

oar-scripting is an helper for OAR's prologue/epilogue writes in Ruby, this
helper :

- Create execution logs in order to debug easely these scripts.
- Seperate into steps each different parts.
- Add stats with the execution duration of each steps, and the
  oar-scripting-graph tool can generates graphs.
- Add the possibilities to use several scripts and load them from a
  directory.
- Steps are overwritable.

# Requirements


## Ruby Gem installation

    $ gem install oar-scripting

# Writting a script

    #!/usr/bin/env ruby
    
    require "rubygems"
    require "oar/scripting"
    
    include OAR::Scripting

## Init a prologue script

    Script.init :prologue

## Init an epilogue script

    Script.init :epilogue

## Job informations

A method __job__ return a __Hash__ with job informations
(prologue/epilogue arguments parsed at the initialization of the __Script__
class) :

    job[:id]          # id of the job
    job[:user]        # user, owner of the job
    job[:nodesfile]   # file containing list of resources


## Steps

### Usage

A step is a ruby block, using the __step__ method and defined by :

- a name as a Ruby Symbol __:name__
- some options as a __Hash__ with these default values :

        options = { :order => 50, :overwrite => false, :continue => true }

### Options description

    :order

Define the step execution order

    :overwrite

If __true__, this step overwrites an other step defined with the same
name.

    :continue

If __false__, block execution of this step will exit the script if an
exception is raised.

### Example

    step :kadeploy, :order => 20 do
      # code
    end

## System calls with logging

### Usage

A system call with logging is made with method __sh__ and defined by :

- the command to launch as a __String__
- some options as a __Hash__ with these default values :

        options : { :return => false, :stderr => true }

### Options descriptions

    :return

If __true__, return the result of command.

    :stderr

If __false__, append _2>/dev/null_ to the command.
If __true__, append _2>&1_ to the command.

### Examples

    sh %{/usr/sbin/karights3 --overwrite-rights -a -f #{job[:nodesfile]} -p /dev/sda3 -u #{job[:user]}}
    KAVLAN_IDS = sh(%{/usr/bin/kavlan -V -j #{job[:id]} -q}, :return => true, :stderr => false).split("\n")

## Split prologue/epilogue into several files

### Load scripts

    Script.load_steps

By default, this command will load _/etc/oar/prologue.d/*.rb_ files for the
prologue and _/etc/oar/epilogue.d/*.rb_ files for the epilogue.

You can change these paths :

    Config[:prologue_d_path] = "/var/lib/oar/prologue.d"
    Config[:epilogue_d_path] = "/var/lib/oar/epilogue.d"

or

    Config[:oar_conf_path] = "/var/lib/oar" # Do the same as the 2 above lines

# Execute resulting ordered steps

    Script.execute

# Generated logs

These log are generated by default in the _/var/log/oar_ directory,
using format _**jobid**-**epilogue|prologue**-**user**.log_

    Config[:log_path] = "/var/lib/oar/scripting/logs" # to change the log path

Example : file _/var/log/oar/419562-epilogue-pmorillo.log_
    
    # Logfile created on Tue Mar 20 15:23:16 +0100 2012 by logger.rb/22285
    I, [2012-03-20T15:23:16.744812 #13719]  INFO -- : [begin]
    I, [2012-03-20T15:23:16.745331 #13719]  INFO -- : [begin_step]kavlan
    I, [2012-03-20T15:23:16.745411 #13719]  INFO -- : [command] /usr/bin/kavlan -V -j 419562 -q 2>/dev/null
    D, [2012-03-20T15:23:17.291268 #13719] DEBUG -- : [result]
    16
    D, [2012-03-20T15:23:17.291518 #13719] DEBUG -- : [command_success]
    I, [2012-03-20T15:23:17.291671 #13719]  INFO -- : [command] /usr/sbin/kavlan_rights -u pmorillo -d -i 16 2>&1
    D, [2012-03-20T15:23:17.617290 #13719] DEBUG -- : [result]
    vlan 16: ok
    D, [2012-03-20T15:23:17.617522 #13719] DEBUG -- : [command_success]
    I, [2012-03-20T15:23:17.617610 #13719]  INFO -- : [end_step]kavlan
    I, [2012-03-20T15:23:17.617703 #13719]  INFO -- : [begin_step]bonfire
    I, [2012-03-20T15:23:17.617768 #13719]  INFO -- : [end_step]bonfire
    I, [2012-03-20T15:23:17.617830 #13719]  INFO -- : [begin_step]kadeploy
    I, [2012-03-20T15:23:17.617924 #13719]  INFO -- : [command] /usr/sbin/karights3 -d -u pmorillo -p /dev/sda3 -f /var/lib/oar/419562 2>&1
    D, [2012-03-20T15:23:18.759796 #13719] DEBUG -- : [result]
    
    D, [2012-03-20T15:23:18.760018 #13719] DEBUG -- : [command_success]
    I, [2012-03-20T15:23:18.760130 #13719]  INFO -- : [command] /usr/bin/kareboot3 -l very_hard --no-wait -p 2 -r env_recorded -e squeeze-x64-prod -u deploy -f /var/lib/oar/419562 2>&1
    D, [2012-03-20T15:23:29.235713 #13719] DEBUG -- : [result]
    --- switch_pxe (paramount cluster)
      >>>  paramount-23.rennes.grid5000.fr
    --- reboot (paramount cluster)
      >>>  paramount-23.rennes.grid5000.fr
      *** A very_hard reboot will be performed on the nodes paramount-23.rennes.grid5000.fr
    --- set_vlan (paramount cluster)
      >>>  paramount-23.rennes.grid5000.fr
      *** Bypass the VLAN setting
    D, [2012-03-20T15:23:29.235938 #13719] DEBUG -- : [command_success]
    I, [2012-03-20T15:23:29.236019 #13719]  INFO -- : [end_step]kadeploy
    I, [2012-03-20T15:23:29.236127 #13719]  INFO -- : [begin_step]oar
    I, [2012-03-20T15:23:29.236226 #13719]  INFO -- : [command] /usr/sbin/oarnodesetting -n -s Absent -p available_upto=0 --sql "resource_id IN (select assigned_resources.resource_id from jobs,assigned_resources,resources where assigned_resource_index = 'CURRENT' AND jobs.state = 'Running' AND jobs.job_id = 419562 and moldable_job_id = jobs.assigned_moldable_job AND (resources.resource_id = assigned_resources.resource_id AND resources.type='default'))" 2>&1
    D, [2012-03-20T15:23:29.971694 #13719] DEBUG -- : [result]
    828 --> Absent
    829 --> Absent
    830 --> Absent
    831 --> Absent
    Update property available_upto with value 0 ...DONE
    Update property available_upto with value 0 ...DONE
    Update property available_upto with value 0 ...DONE
    Update property available_upto with value 0 ...DONE
    D, [2012-03-20T15:23:29.971923 #13719] DEBUG -- : [command_success]
    I, [2012-03-20T15:23:29.972006 #13719]  INFO -- : [end_step]oar
    I, [2012-03-20T15:23:29.972110 #13719]  INFO -- : [end]
    I, [2012-03-20T15:23:29.972314 #13719]  INFO -- : [stats]{"duration":13.227624,"steps":[{"duration":0.872287,"name":"kavlan","order":20},{"duration":7.4e-05,"name":"bonfire","order":30},{"duration":11.618219,"name":"kadeploy","order":40},{"duration":0.735891,"name":"oar","order":60}],"job":{"user":"pmorillo","resources_count":4,"host_count":1,"nodesfile":"/var/lib/oar/419562","id":"419562"}}



# Generate graphs

    oar-scripting-graph --output /tmp

This command will create the directory _/tmp/oar-scripting-graph_ with web pages and graphs.

__Note :__ This script work only with default log path (options will be
implemented later).

# Full Epilogue example used on a Grid'5000 frontend

This epilogue gerenerate the log above.

## File _/etc/oar/epilogue_

    #!/usr/bin/env ruby
    # MANAGED BY PUPPET
    # Module : oarg5k
    # File   : puppet:///modules/oarg5k/rennes/epilogue
    
    require 'rubygems'
    require 'oar/scripting'
    
    include OAR::Scripting
    
    Script.init :epilogue
    
    Script.load_steps
    
    step :bonfire, :order => 30 do
      if job[:user] == "bonfire"
        sh %{kavlan -s -i DEFAULT -f #{job[:nodesfile]}}
      end
    end
    
    Script.execute

## File _/etc/oar/epilogue.d/kavlan.rb_

    # MANAGED BY PUPPET
    # Module  : kavlang5k
    # File    : puppet:///modules/kavlang5k/commons/oar/epilogue_kavlan.rb
    
    step :kavlan, :order => 20 do
      KAVLAN_IDS = sh(%{/usr/bin/kavlan -V -j #{job[:id]} -q}, :return => true, :stderr => false).split("\n")
      if !KAVLAN_IDS.empty?
        sh %{/usr/sbin/kavlan_rights -u #{job[:user]} -d -i #{KAVLAN_IDS.join(" -i ")}}
        KAVLAN_IDS.each do |vlan|
          if vlan.to_i < 4
            sh %{ssh kavlan-#{vlan} "echo \\"-:ALL:ALL\\" > /var/lib/oar/access.conf; sudo /etc/init.d/dhcp3-server restart; sudo pkill -9 -u #{job[:user]}"}
          end
        end
      end
    end

## File _/etc/oar/epilogue.d/kadeploy.rb_

    # MANAGED BY PUPPET
    # Module  : kadeployg5k
    # File    : puppet:///modules/kadeployg5k/oar/epilogue_kadeploy.rb
    
    step :kadeploy, :order => 40 do
      # Revoke kadeploy rights that were granted to the user for the time of the job
      sh %{/usr/sbin/karights3 -d -u #{job[:user]} -p /dev/sda3 -f #{job[:nodesfile]}}
    
      # Reboot the nodes.
      # NB: the command is launched in background, because it can take time to
      # return, and oar can grow impatient... For the nohup to work properly, we
      # need to redirect all descriptors.
      sh %{/usr/bin/kareboot3 -l very_hard --no-wait -p 2 -r env_recorded -e squeeze-x64-prod -u deploy -f #{job[:nodesfile]}}
    end

## File  _/etc/oar/epilogue.d/oar.rb_

    # MANAGED BY PUPPET
    # Module  : kadeployg5k
    # File    : puppet:///modules/kadeployg5k/oar/epilogue_oar.rb
    
    step :oar, :order => 60 do
      # Mark nodes as Absent as they are rebooting
      sh %{/usr/sbin/oarnodesetting -n -s Absent -p available_upto=0 --sql "resource_id IN (select assigned_resources.resource_id from jobs,assigned_resources,resources where assigned_resource_index = 'CURRENT' AND jobs.state = 'Running' AND jobs.job_id = #{job[:id]} and moldable_job_id = jobs.assigned_moldable_job AND (resources.resource_id = assigned_resources.resource_id AND resources.type='default'))"}
    end

